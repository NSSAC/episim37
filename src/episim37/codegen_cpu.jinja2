{# Codegen CPU Macros #}

{% macro enum_type(t) %}
typedef {{ t.base_type | codegen }} {{ t.name }};
{% for const in t.consts %}
#define {{ const }} {{ loop.index0 }}
{% endfor %}
{% endmacro %}

{% macro config(c) %}
{{ c.type | codegen }} {{ c.name }} = {{ c.default | codegen }};
{% endmacro %}


{% macro source(s) %}
#include <cinttypes>
#include <cstdlib>
#include <iomanip>
#include <iostream>

{% for c in s.configs %}
{{ c | codegen }}
{% endfor %}

{% for e in s.enums %}
{{ e | codegen }}
{% endfor %}

int main() {
    std::cout << std::boolalpha;
    {% for c in s.configs %}
    {
        char *p = std::getenv("{{ c.name | upper }}");
        if (p) {
            {{ c.name }} = {{ c.type.name | cstr_to_ctype }}(p);
        }
        // std::cout << "{{ c.name }} = " << {{ c.type.name | cout_cast }}({{ c.name }}) << std::endl;
    }
    {% endfor %}

    {% for statement in s.main_function.body %}
    {{ statement | codegen }}
    {% endfor %}

    return 0;
}
{% endmacro %}


{% macro cmake_lists(s) %}
cmake_minimum_required(VERSION 3.27)

project({{s.source.module}} VERSION 0.0.1)

add_executable(simulator simulator.cpp)
{% endmacro %}


